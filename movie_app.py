# movie_app.py

import streamlit as st
import google.generativeai as genai
from openai import OpenAI

# â”€â”€â”€ 1. ãƒšãƒ¼ã‚¸è¨­å®š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(
    page_title="æ˜ åƒåˆ¶ä½œAIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ",
    layout="centered"
)

# â”€â”€â”€ 2. Secrets èª­ã¿è¾¼ã¿ & ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
GEMINI_API_KEY = st.secrets["GEMINI_API_KEY"]
OPENAI_API_KEY = st.secrets["OPENAI_API_KEY"]
APP_PASSWORD   = st.secrets["APP_PASSWORD"]

genai.configure(api_key=GEMINI_API_KEY)
openai_client = OpenAI(api_key=OPENAI_API_KEY)

# â”€â”€â”€ 3. èªè¨¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.title("æ˜ åƒåˆ¶ä½œAIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆä¸‰æ®µéšãƒ—ãƒ­ãƒ³ãƒ—ãƒˆåŒ–ç‰ˆï¼‰")
password = st.text_input("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", type="password")
if password != APP_PASSWORD:
    st.warning("ğŸ”’ èªè¨¼ãŒå¿…è¦ã§ã™")
    st.stop()

# â”€â”€â”€ 4. ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.header("åˆ¶ä½œæ¡ä»¶ã®å…¥åŠ›")
video_duration = st.selectbox("å°ºã®é•·ã•", ["15ç§’", "30ç§’", "60ç§’", "ãã®ä»–"])
final_duration = (
    st.text_input("å°ºã®é•·ã•ï¼ˆè‡ªç”±è¨˜å…¥ï¼‰") if video_duration == "ãã®ä»–" else video_duration
)
num_versions   = st.number_input("ç´å“æœ¬æ•°", min_value=1, max_value=10, value=1)
shoot_days     = st.number_input("æ’®å½±æ—¥æ•°", min_value=1, max_value=10, value=2)
edit_days      = st.number_input("ç·¨é›†æ—¥æ•°", min_value=1, max_value=10, value=3)
delivery_date  = st.date_input("ç´å“å¸Œæœ›æ—¥")
cast_main      = st.number_input("ãƒ¡ã‚¤ãƒ³ã‚­ãƒ£ã‚¹ãƒˆäººæ•°", 0, 10, 1)
cast_extra     = st.number_input("ã‚¨ã‚­ã‚¹ãƒˆãƒ©äººæ•°", 0, 20, 0)
talent_use     = st.checkbox("ã‚¿ãƒ¬ãƒ³ãƒˆèµ·ç”¨ã‚ã‚Š")
staff_roles    = st.multiselect(
    "å¿…è¦ãªã‚¹ã‚¿ãƒƒãƒ•",
    ["åˆ¶ä½œãƒ—ãƒ­ãƒ‡ãƒ¥ãƒ¼ã‚µãƒ¼", "åˆ¶ä½œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼", "ãƒ‡ã‚£ãƒ¬ã‚¯ã‚¿ãƒ¼", "ã‚«ãƒ¡ãƒ©ãƒãƒ³",
     "ç…§æ˜ã‚¹ã‚¿ãƒƒãƒ•", "ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆ", "ãƒ˜ã‚¢ãƒ¡ã‚¤ã‚¯", "ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ"]
)
shoot_location     = st.text_input("æ’®å½±å ´æ‰€ï¼ˆä¾‹ï¼šéƒ½å†…ã‚¹ã‚¿ã‚¸ã‚ªï¼‹ãƒ­ã‚±ï¼‰")
kizai              = st.multiselect("æ’®å½±æ©Ÿæ", ["4Kã‚«ãƒ¡ãƒ©", "ç…§æ˜", "ãƒ‰ãƒ­ãƒ¼ãƒ³", "ã‚°ãƒªãƒ¼ãƒ³ãƒãƒƒã‚¯"])
set_design_quality = st.selectbox(
    "ã‚»ãƒƒãƒˆå»ºã¦ãƒ»ç¾è¡“è£…é£¾ã®è¦æ¨¡",
    ["ãªã—", "å°ï¼ˆç°¡æ˜“è£…é£¾ï¼‰", "ä¸­ï¼ˆé€šå¸¸ãƒ¬ãƒ™ãƒ«ï¼‰", "å¤§ï¼ˆæœ¬æ ¼ã‚»ãƒƒãƒˆï¼‰"]
)
use_cg        = st.checkbox("CGãƒ»VFXã‚ã‚Š")
use_narration = st.checkbox("ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åéŒ²ã‚ã‚Š")
use_music     = st.selectbox("éŸ³æ¥½ç´ æ", ["æ—¢å­˜ãƒ©ã‚¤ã‚»ãƒ³ã‚¹éŸ³æº", "ã‚ªãƒªã‚¸ãƒŠãƒ«åˆ¶ä½œ", "æœªå®š"])
ma_needed     = st.checkbox("MAã‚ã‚Š")
deliverables  = st.multiselect("ç´å“å½¢å¼", ["mp4ï¼ˆ16:9ï¼‰", "mp4ï¼ˆ1:1ï¼‰", "mp4ï¼ˆ9:16ï¼‰", "ProRes"])
subtitle_langs = st.multiselect("å­—å¹•è¨€èª", ["æ—¥æœ¬èª", "è‹±èª", "ãã®ä»–"])
usage_region  = st.selectbox("ä½¿ç”¨åœ°åŸŸ", ["æ—¥æœ¬å›½å†…", "ã‚°ãƒ­ãƒ¼ãƒãƒ«", "æœªå®š"])
usage_period  = st.selectbox("ä½¿ç”¨æœŸé–“", ["6ãƒ¶æœˆ", "1å¹´", "2å¹´", "ç„¡æœŸé™", "æœªå®š"])
budget_hint   = st.text_input("å‚è€ƒäºˆç®—ï¼ˆä»»æ„ï¼‰")
extra_notes   = st.text_area("ãã®ä»–å‚™è€ƒï¼ˆä»»æ„ï¼‰")
model_choice  = st.selectbox("ä½¿ç”¨ã™ã‚‹AIãƒ¢ãƒ‡ãƒ«", ["Gemini", "GPT-4o", "GPT-4.1"])

# â”€â”€â”€ 5. æ¡ä»¶ä¸€è¦§ãƒ†ã‚­ã‚¹ãƒˆä½œæˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
items = [
    ("åˆ¶ä½œãƒ—ãƒ­ãƒ‡ãƒ¥ãƒ¼ã‚µãƒ¼è²»", 150_000, f"1åÃ—{shoot_days}æ—¥"),
    ("åˆ¶ä½œPMè²»",      100_000, f"1åÃ—{shoot_days}æ—¥"),
    ("ãƒ‡ã‚£ãƒ¬ã‚¯ã‚¿ãƒ¼è²»",120_000, f"1åÃ—{shoot_days}æ—¥"),
    ("ã‚«ãƒ¡ãƒ©ãƒãƒ³è²»",    100_000, "1åÃ—1æ—¥"),
]
condition_lines = "\n".join(
    f"- {name} â€” å˜ä¾¡ï¼š{price}ã€æ•°é‡ï¼š{qty}"
    for name, price, qty in items
)

# â”€â”€â”€ 6. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆâ‘ ï¼šè¡Œã”ã¨ã®è¨ˆç®— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
prompt1 = f"""
ä»¥ä¸‹ã®å„é …ç›®ã«ã¤ã„ã¦ã€Œå˜ä¾¡ Ã— æ•°é‡ã€ã®è¨ˆç®—çµæœã‚’ã€
ã€Œé …ç›®åï¼šè¨ˆç®—çµæœï¼ˆå††ï¼‰ã€ã®å½¢å¼ã§ä¸€è¡Œãšã¤è¿”ã—ã¦ãã ã•ã„ã€‚

{condition_lines}
"""

# â”€â”€â”€ 7. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆâ‘¡ï¼šåˆè¨ˆè¨ˆç®— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
prompt2 = """
ä¸Šè¨˜ã®ä¸€è¦§ã‚’å—ã‘å–ã‚Šã€ã™ã¹ã¦ã®é‡‘é¡ã‚’è¶³ã—åˆã‚ã›ã¦ã€
ã€Œåˆè¨ˆé‡‘é¡ï¼ˆå††ï¼‰ï¼šâ—‹â—‹â—‹â—‹â—‹â—‹ã€ã¨ã—ã¦1è¡Œã§è¿”ã—ã¦ãã ã•ã„ã€‚
"""

# â”€â”€â”€ 8. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆâ‘¢ï¼šæœ€çµ‚è¦‹ç©æ›¸ç”Ÿæˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
prompt3_template = """
ã‚ãªãŸã¯åºƒå‘Šåˆ¶ä½œè²»ã®ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªè¦‹ç©ã‚‚ã‚Šã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚
ä»¥ä¸‹ã®æ¡ä»¶ã«åŸºã¥ã„ã¦ã€æ˜ åƒåˆ¶ä½œã«å¿…è¦ãªè²»ç”¨ã‚’è©³ç´°ã«è¦‹ç©ã‚‚ã£ã¦ãã ã•ã„ã€‚
äºˆç®—ã€ç´æœŸã€ä»•æ§˜ã€ã‚¹ã‚¿ãƒƒãƒ•æ§‹æˆã€æ’®å½±æ¡ä»¶ãªã©ã‹ã‚‰ã€å®Ÿå‹™ã«å³ã—ãŸå†…å®¹ã§æ­£ç¢ºã‹ã¤è«–ç†çš„ã«æ¨è«–ã—ã¦ãã ã•ã„ã€‚
çŸ­ç´æœŸã§ã‚ã‚‹å ´åˆã‚„ä»•æ§˜ãŒè¤‡é›‘ãªå ´åˆã«ã¯ã€å·¥æ•°ã‚„è²»ç”¨ãŒå¢—ãˆã‚‹ç‚¹ã‚‚åŠ å‘³ã—ã¦ãã ã•ã„ã€‚

ã€é …ç›®åˆ¥è¨ˆç®—çµæœã€‘
{calc1}

ã€åˆè¨ˆé‡‘é¡ã€‘
{calc2}

# å‡ºåŠ›å½¢å¼è¦ä»¶
- HTML + Markdownå½¢å¼ã§èª­ã¿ã‚„ã™ã
- ãƒ†ãƒ¼ãƒ–ãƒ«ã€Œé …ç›®åãƒ»è©³ç´°ãƒ»å˜ä¾¡ãƒ»æ•°é‡ãƒ»é‡‘é¡ã€ã‚’å«ã‚€
- åˆè¨ˆé‡‘é¡ã¯å¤ªå­—ã¾ãŸã¯è‰²ä»˜ãã§å¼·èª¿
- å‚™è€ƒã‚„æ³¨æ„ç‚¹ã‚’è¨˜è¼‰
- ãƒ•ã‚©ãƒ³ãƒˆã¯ Arial ã‚’æƒ³å®š
- æ­£ã—ã„ HTML æ§‹é€ ã§å‡ºåŠ›ã—ã¦ãã ã•ã„
"""

# â”€â”€â”€ 9. ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®å‡¦ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if st.button("ğŸ’¡ è¦‹ç©ã‚‚ã‚Šã‚’ä½œæˆ"):
    with st.spinner("AIãŒè¦‹ç©ã‚‚ã‚Šã‚’ä½œæˆä¸­â€¦"):
        # â—† Gemini ãƒ¢ãƒ¼ãƒ‰
        if model_choice == "Gemini":
            calc1 = genai.GenerativeModel("gemini-2.0-flash").generate_content(prompt1).text
            calc2 = genai.GenerativeModel("gemini-2.0-flash") \
                         .generate_content(prompt2 + "\n" + calc1).text
            prompt3 = prompt3_template.format(calc1=calc1, calc2=calc2)
            final = genai.GenerativeModel("gemini-2.0-flash").generate_content(prompt3).text

        else:
            # ãƒ¢ãƒ‡ãƒ«åé¸æŠ
            model_name = "gpt-4o" if model_choice == "GPT-4o" else "gpt-4.1"
            # â‘  è¡Œè¨ˆç®—
            r1 = openai_client.chat.completions.create(
                model=model_name,
                messages=[{"role":"system","content":"ã‚ãªãŸã¯è¨ˆç®—ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚"},
                          {"role":"user","content":prompt1}],
            )
            calc1 = r1.choices[0].message.content
            # â‘¡ åˆè¨ˆè¨ˆç®—
            r2 = openai_client.chat.completions.create(
                model=model_name,
                messages=[{"role":"system","content":"ã‚ãªãŸã¯è¨ˆç®—ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚"},
                          {"role":"user","content":prompt2 + "\n" + calc1}],
            )
            calc2 = r2.choices[0].message.content
            # â‘¢ è¦‹ç©æ›¸ç”Ÿæˆ
            prompt3 = prompt3_template.format(calc1=calc1, calc2=calc2)
            r3 = openai_client.chat.completions.create(
                model=model_name,
                messages=[{"role":"system","content":"ã‚ãªãŸã¯åºƒå‘Šæ˜ åƒã®è¦‹ç©ã‚‚ã‚Šã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚"},
                          {"role":"user","content":prompt3}],
                temperature=0.7,
            )
            final = r3.choices[0].message.content

        # â”€â”€â”€ 10. çµæœè¡¨ç¤º â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        st.success("âœ… å®Œæˆã•ã‚ŒãŸè¦‹ç©æ›¸")
        st.components.v1.html(
            f"<div style='font-family:Arial;line-height:1.6;padding:12px'>{final}</div>",
            height=900,
            scrolling=True
        )
